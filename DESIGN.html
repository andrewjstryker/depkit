<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>DESIGN.md — depkit • depkit</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="DESIGN.md — depkit"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">depkit</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="articles/depkit.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="DESIGN.html">Design</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="external-link nav-link" href="https://github.com/andrewjstryker/depkit" aria-label="GitHub repository"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>DESIGN.md — depkit</h1>
      <small class="dont-index">Source: <a href="https://github.com/andrewjstryker/depkit/blob/main/DESIGN.md" class="external-link"><code>DESIGN.md</code></a></small>
    </div>

<div id="designmd--depkit" class="section level1">

<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a></h2>
<p><strong>depkit</strong> is a build-time HTML asset and dependency manager for R.</p>
<p>It manages <strong>CSS and JavaScript assets</strong> produced by R tooling (notably <code>htmlwidgets</code>) and provides a deterministic, usage-agnostic way to:</p>
<ul><li>deduplicate assets,</li>
<li>preserve first-seen ordering,</li>
<li>copy local assets into a target directory,</li>
<li>optionally apply verified CDN logic for JavaScript, and</li>
<li>
<strong>emit HTML snippets</strong> (<code>&lt;link&gt;</code>, <code>&lt;script&gt;</code>) for callers to insert into documents they are constructing.</li>
</ul><p>depkit <strong>does not</strong> write HTML files, track what has been emitted, or impose document layout policy.</p>
<hr></div>
<div class="section level2">
<h2 id="sharpened-focus">Sharpened focus<a class="anchor" aria-label="anchor" href="#sharpened-focus"></a></h2>
<div class="section level3">
<h3 id="depkit-does">depkit does<a class="anchor" aria-label="anchor" href="#depkit-does"></a></h3>
<ul><li>Track CSS and JS assets as <strong>ordered unique sets</strong>
</li>
<li>Deduplicate dependencies by <code>name@version</code>
</li>
<li>Copy local assets into a configured output directory</li>
<li>Optionally verify and emit CDN-backed JavaScript with fallback</li>
<li>Emit HTML snippets for either:
<ul><li>newly added assets, or</li>
<li>all known assets (ordered, deduped)</li>
</ul></li>
</ul></div>
<div class="section level3">
<h3 id="depkit-does-not">depkit does not<a class="anchor" aria-label="anchor" href="#depkit-does-not"></a></h3>
<ul><li>Write complete HTML documents</li>
<li>Track whether assets were emitted or not</li>
<li>Decide where snippets belong in a document</li>
<li>Maintain “prepared” or “emitted” state</li>
<li>Integrate with site generators (Hugo, etc.)</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="core-concepts">Core concepts<a class="anchor" aria-label="anchor" href="#core-concepts"></a></h2>
<div class="section level3">
<h3 id="dependency-key">Dependency key<a class="anchor" aria-label="anchor" href="#dependency-key"></a></h3>
<p>A dependency is uniquely identified by:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dep_key</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dep</span><span class="op">$</span><span class="va">name</span>, <span class="st">"@"</span>, <span class="va">dep</span><span class="op">$</span><span class="va">version</span><span class="op">)</span></span></code></pre></div>
<p>This key is used for registry deduplication.</p>
<hr></div>
<div class="section level3">
<h3 id="asset-id">Asset id<a class="anchor" aria-label="anchor" href="#asset-id"></a></h3>
<p>An asset is uniquely identified by:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">asset_id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dep_key</span>, <span class="st">"::"</span>, <span class="va">rel_path</span><span class="op">)</span></span></code></pre></div>
<p>Where <code>rel_path</code> is the stylesheet or script path declared by the dependency.</p>
<p>Asset ids are: - stable - output-agnostic - the sole unit tracked by the dependency manager</p>
<p>URL resolution and filesystem paths are derived later.</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="architecture">Architecture<a class="anchor" aria-label="anchor" href="#architecture"></a></h2>
<p>depkit has <strong>two public classes</strong> and <strong>one internal representation</strong>.</p>
<hr></div>
<div class="section level2">
<h2 id="class-diagram">Class diagram<a class="anchor" aria-label="anchor" href="#class-diagram"></a></h2>
<pre class="mermaid"><code>classDiagram
  class DependencyManager {
    &lt;&lt;S4&gt;&gt;
    +registry: named list&lt;html_dependency&gt;
    +css_assets: character
    +js_assets: character
    +config: list

    +insert(x) InsertUpdate
    +emit_css(keys=NULL) character
    +emit_js(keys=NULL) character
    +has(key) logical
    +remove(key) DependencyManager
    +names() character
    +length() integer
  }



  class InsertUpdate {
    &lt;&lt;S4&gt;&gt;
    +dm: DependencyManager
    +added_css: character
    +added_js: character

    +dm() DependencyManager
    +is_empty() logical
    +emit_css() character
    +emit_js() character
    +insert(x) InsertUpdate
  }

  InsertUpdate --&gt; DependencyManager : dm
  DependencyManager --&gt; InsertUpdate : insert()
</code></pre>
<hr></div>
<div class="section level2">
<h2 id="dependencymanager">DependencyManager<a class="anchor" aria-label="anchor" href="#dependencymanager"></a></h2>
<div class="section level3">
<h3 id="responsibilities">Responsibilities<a class="anchor" aria-label="anchor" href="#responsibilities"></a></h3>
<p>The <code>DependencyManager</code> (DM) holds the <strong>only persistent state</strong> in depkit:</p>
<ul><li>dependency registry (deduped by <code>dep_key</code>)</li>
<li>ordered unique CSS asset ids</li>
<li>ordered unique JS asset ids</li>
<li>configuration (Option A)</li>
</ul></div>
<div class="section level3">
<h3 id="configuration-option-a">Configuration (Option A)<a class="anchor" aria-label="anchor" href="#configuration-option-a"></a></h3>
<p>Configuration is stored on the DM and applies uniformly:</p>
<ul><li>
<code>output_root</code> — filesystem directory for copied assets</li>
<li>
<code>url_root</code> — URL prefix used in emitted tags</li>
<li>
<code>cdn</code> — logical; automatic CDN resolution via jsDelivr (JavaScript only)</li>
</ul><p>Configuration affects copying and emission, but is <strong>not stateful</strong> in the sense of “prepared” or “emitted”.</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="insertupdate-delta--façade">InsertUpdate (delta + façade)<a class="anchor" aria-label="anchor" href="#insertupdate-delta--fa%C3%A7ade"></a></h2>
<div class="section level3">
<h3 id="purpose">Purpose<a class="anchor" aria-label="anchor" href="#purpose"></a></h3>
<p><code>InsertUpdate</code> is a <strong>higher-level API object</strong> that:</p>
<ul><li>captures “what changed” during an insertion</li>
<li>delegates emission back to the DM</li>
<li>reduces caller reasoning burden</li>
</ul><p>It is <strong>not</strong> plumbing and introduces no new capability.</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="insert-semantics">Insert semantics<a class="anchor" aria-label="anchor" href="#insert-semantics"></a></h2>
<div class="section level3">
<h3 id="insertdm-x"><code>insert(dm, x)</code><a class="anchor" aria-label="anchor" href="#insertdm-x"></a></h3>
<p>Insertion is functional:</p>
<ol style="list-style-type: decimal"><li>Normalize input (<code>html_dependency</code>, <code>htmlwidget</code>, list)</li>
<li>Resolve dependencies and their assets into asset ids</li>
<li>Compare asset ids to DM’s ordered sets</li>
</ol><div class="section level4">
<h4 id="case-1-already-present">Case 1: Already present<a class="anchor" aria-label="anchor" href="#case-1-already-present"></a></h4>
<ul><li>No new asset ids discovered</li>
<li>No files copied</li>
<li>Return <code>InsertUpdate</code> with empty <code>added_css</code> / <code>added_js</code>
</li>
<li>DM is returned unchanged</li>
</ul></div>
<div class="section level4">
<h4 id="case-2-new-assets-discovered">Case 2: New assets discovered<a class="anchor" aria-label="anchor" href="#case-2-new-assets-discovered"></a></h4>
<ul><li><p>Extend DM’s ordered sets with new asset ids</p></li>
<li>
<p>Copy local asset files for <strong>new assets only</strong></p>
<ul><li>overwriting is allowed</li>
<li>skipping identical files is preferred but optional</li>
</ul></li>
<li><p>Return <code>InsertUpdate</code> containing only newly added asset ids</p></li>
</ul></div>
</div>
<div class="section level3">
<h3 id="key-invariant">Key invariant<a class="anchor" aria-label="anchor" href="#key-invariant"></a></h3>
<blockquote>
<p><strong>DM never tracks whether assets were emitted or prepared.</strong> It only tracks <strong>what assets exist</strong>, in order.</p>
</blockquote>
<hr></div>
</div>
<div class="section level2">
<h2 id="emission-model">Emission model<a class="anchor" aria-label="anchor" href="#emission-model"></a></h2>
<div class="section level3">
<h3 id="emission-via-insertupdate-new-only">Emission via InsertUpdate (new-only)<a class="anchor" aria-label="anchor" href="#emission-via-insertupdate-new-only"></a></h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/insert.html">insert</a></span><span class="op">(</span><span class="va">dm</span>, <span class="va">widget</span><span class="op">)</span></span>
<span><span class="va">html</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/emit_css.html">emit_css</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span></span></code></pre></div>
<ul><li>Emits snippets <strong>only for newly added assets</strong>
</li>
<li>Implemented by calling DM emission with <code>keys = added_asset_ids</code>
</li>
<li>Does not mutate DM or InsertUpdate</li>
</ul><hr></div>
<div class="section level3">
<h3 id="emission-via-dependencymanager-all-assets">Emission via DependencyManager (all assets)<a class="anchor" aria-label="anchor" href="#emission-via-dependencymanager-all-assets"></a></h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">html_css</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/emit_css.html">emit_css</a></span><span class="op">(</span><span class="va">dm</span><span class="op">)</span></span>
<span><span class="va">html_js</span>  <span class="op">&lt;-</span> <span class="fu"><a href="reference/emit_js.html">emit_js</a></span><span class="op">(</span><span class="va">dm</span><span class="op">)</span></span></code></pre></div>
<ul><li>Emits all assets of the given type</li>
<li>Preserves first-seen order</li>
<li>No deduplication logic required at emit time</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="internal-asset-records-implementation-detail">Internal asset records (implementation detail)<a class="anchor" aria-label="anchor" href="#internal-asset-records-implementation-detail"></a></h2>
<p>depkit constructs <strong>ephemeral asset records</strong> internally during:</p>
<ul><li>insertion (for copying)</li>
<li>emission (for tag generation)</li>
</ul><p>These records are <strong>not stored</strong> and <strong>not part of public API</strong>.</p>
<div class="section level3">
<h3 id="conceptual-structure">Conceptual structure<a class="anchor" aria-label="anchor" href="#conceptual-structure"></a></h3>
<p>Each internal asset record contains:</p>
<p>Common:</p>
<ul><li><code>asset_id</code></li>
<li>
<code>kind</code> (<code>css</code> / <code>js</code>)</li>
<li><code>dep_key</code></li>
<li><code>rel_path</code></li>
<li><code>src_dir</code></li>
<li><code>out_path</code></li>
<li><code>url</code></li>
</ul><p>JavaScript only (when <code>cdn = TRUE</code>):</p>
<ul><li>
<code>cdn_url</code> (optional, resolved automatically via jsDelivr)</li>
<li>
<code>integrity</code> (sha384, SRI hash)</li>
<li><code>fallback_url</code></li>
</ul><p>Records are derived deterministically from:</p>
<ul><li>DM state</li>
<li>configuration</li>
<li>filesystem inspection</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="emission-behavior">Emission behavior<a class="anchor" aria-label="anchor" href="#emission-behavior"></a></h2>
<div class="section level3">
<h3 id="css">CSS<a class="anchor" aria-label="anchor" href="#css"></a></h3>
<ul><li>Always local-only</li>
<li>Emitted as:</li>
</ul><div class="sourceCode" id="cb6"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">link</span> <span class="er">rel</span><span class="ot">=</span><span class="st">"stylesheet"</span> <span class="er">href</span><span class="ot">=</span><span class="st">"URL"</span><span class="dt">&gt;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="javascript">JavaScript<a class="anchor" aria-label="anchor" href="#javascript"></a></h3>
<ul><li>
<p><code>cdn = FALSE</code></p>
<ul><li>Emit local <code>&lt;script src="URL"&gt;&lt;/script&gt;</code>
</li>
</ul></li>
<li>
<p><code>cdn = TRUE</code></p>
<ul><li>At insert time, query jsDelivr API for the npm package matching the dependency name and version</li>
<li>Hash-match local JS files against jsDelivr’s file listing</li>
<li>If matched:</li>
</ul></li>
</ul><div class="sourceCode" id="cb7"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span> <span class="er">src</span><span class="ot">=</span><span class="st">"CDN_URL"</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="ot">        integrity=</span><span class="st">"sha384-..."</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="ot">        crossorigin=</span><span class="st">"anonymous"</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="ot">        onerror=</span><span class="st">"this.onerror=null;this.src='LOCAL_URL';"</span><span class="dt">&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<ul><li>If no match or any error: silently emit local-only</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="typical-workflow-caller-defined-policy">Typical workflow (caller-defined policy)<a class="anchor" aria-label="anchor" href="#typical-workflow-caller-defined-policy"></a></h2>
<p>Example: “emit CSS as encountered, JS at end”</p>
<pre class="mermaid"><code>flowchart TD
  A["Start: dm"] --&gt; B["insert(dm, widget1) -&gt; u1"]
  B --&gt; C["emit_css(u1)"]
  C --&gt; D["dm1 = dm(u1)"]
  D --&gt; E["insert(dm1, widget2) -&gt; u2"]
  E --&gt; F["emit_css(u2)"]
  F --&gt; G["dm2 = dm(u2)"]
  G --&gt; H["End of document"]
  H --&gt; I["emit_js(dm2)"]</code></pre>
<p>depkit enables this policy but does not enforce it.</p>
<hr></div>
<div class="section level2">
<h2 id="error-handling-philosophy">Error handling philosophy<a class="anchor" aria-label="anchor" href="#error-handling-philosophy"></a></h2>
<ul><li>Malformed dependencies → hard error</li>
<li>Asset copy failure → hard error</li>
<li>CDN verification failure → warning + local fallback</li>
<li>Network failures are never fatal</li>
</ul><p>depkit always <strong>fails closed</strong> to local assets.</p>
<hr></div>
<div class="section level2">
<h2 id="coding-style-guidance">Coding style guidance<a class="anchor" aria-label="anchor" href="#coding-style-guidance"></a></h2>
<ul><li>
<p><strong>Avoid probing-for-correctness</strong></p>
<ul><li>Use explicit class checks; fail fast</li>
</ul></li>
<li>
<p><strong>Keep porcelain thin</strong></p>
<ul><li>S4 orchestrates; logic lives in utilities</li>
</ul></li>
<li>
<p><strong>Determinism over cleverness</strong></p>
<ul><li>Preserve insertion order; no implicit sorting</li>
</ul></li>
<li>
<p><strong>No hidden state</strong></p>
<ul><li>No “prepared”, “emitted”, or “already handled” flags</li>
</ul></li>
</ul><hr></div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a></h2>
<p>depkit provides a clean, deterministic boundary:</p>
<ul><li>
<strong>DependencyManager</strong> — canonical asset state</li>
<li>
<strong>InsertUpdate</strong> — explicit delta + ergonomic emission</li>
<li>
<strong>Insert</strong> — may copy new assets</li>
<li>
<strong>Emit</strong> — returns HTML snippets, nothing more</li>
</ul><p>Callers decide <em>where</em> snippets go. depkit decides <em>what</em> those snippets are.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Andrew Stryker.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

